---
# tasks file for ansible-role-tripleo-overcloud-validate-ha

- name: Creating the environment file on undercloud
  delegate_to: undercloud
  template:
    src: "{{ environment_file }}"
    dest: "{{ working_dir }}/environment"
    mode: 0600

- name: Load the workarounds script on the undercloud
  delegate_to: undercloud
  template:
    src: "{{ workarounds_script }}"
    dest: "{{ working_dir }}/workarounds.sh"
    mode: 0755

- name: Execute workarounds script on the undercloud
  delegate_to: undercloud
  shell: >
    "{{ working_dir }}/workarounds.sh"

- name: Get overcloud-ha-test-suite on undercloud and controllers
  vars:
    nodes:
      - "undercloud"
      - "{{ groups['controller'] }}"
  shell: >
    rm -rf tripleo-director-ha-test-suite;
    git clone https://github.com/rscarazz/tripleo-director-ha-test-suite/ tripleo-director-ha-test-suite;
  delegate_to: "{{ item }}"
  with_items: "{{ nodes }}"

- name: HA test failed actions (overcloud)
  delegate_to: overcloud-controller-0
  shell: >
    {{ overcloud_working_dir }}/tripleo-director-ha-test-suite/TD-ha-test-suite.sh -t {{ overcloud_working_dir }}/tripleo-director-ha-test-suite/test/test_check-failed-actions > {{ overcloud_working_dir }}/test_failed-actions.log 2>&1

- name: HA Test instance deploy on the overcloud (undercloud)
  delegate_to: undercloud
  shell: >
    {{ working_dir }}/tripleo-director-ha-test-suite/TD-ha-test-suite.sh -t {{ working_dir }}/tripleo-director-ha-test-suite/test/test_instance-creation -r {{ working_dir }}/tripleo-director-ha-test-suite/recovery/recovery_instance-creation > {{ working_dir }}/test_instance.log 2>&1

#- name: HA test A
#  delegate_to: overcloud-controller-0
#  shell: |
#    {{ overcloud_working_dir }}/{{ test_ha_script }}.sh -t "A" -r "10" > {{ test_ha_log }} 2>&1
